# ğŸ—ï¸ Architecture Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT APPLICATIONS                          â”‚
â”‚  (Web, Mobile, Backend Services, Scripts, etc.)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ HTTPS + Bearer Token
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUDFLARE WORKERS EDGE                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Lab Sessions API Worker                     â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚  â”‚   Router        â”‚       â”‚   Logger         â”‚              â”‚  â”‚
â”‚  â”‚  â”‚   (index.ts)    â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚   (logger.ts)    â”‚              â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚       â”‚                  â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Routes        â”‚       â”‚ â€¢ 5 Log Levels   â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Auth Check    â”‚       â”‚ â€¢ Timestamps     â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ CORS          â”‚       â”‚ â€¢ Context        â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Error Handler â”‚       â”‚ â€¢ Structured     â”‚              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â”‚           â”‚                                                   â”‚  â”‚
â”‚  â”‚           â”‚                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚  â”‚   Authentication  â”‚     â”‚   Handlers       â”‚              â”‚  â”‚
â”‚  â”‚  â”‚   (utils.ts)      â”‚     â”‚   (handlers.ts)  â”‚              â”‚  â”‚
â”‚  â”‚  â”‚                   â”‚     â”‚                  â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ extractBearerTokâ”‚     â”‚ â€¢ createSession  â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ authenticateReq â”‚     â”‚ â€¢ getSession     â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ timingSafeEqual â”‚     â”‚ â€¢ updateSession  â”‚              â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ 401 Response    â”‚     â”‚ â€¢ deleteSession  â”‚              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â”‚                                      â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                             â”‚                         â”‚
            â”‚                             â”‚                         â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  D1 Database    â”‚         â”‚  Cron Triggers     â”‚    â”‚  Backend API       â”‚
   â”‚  (SQLite)       â”‚         â”‚                    â”‚    â”‚                    â”‚
   â”‚                 â”‚         â”‚  */1 * * * *       â”‚    â”‚  VM Deletion       â”‚
   â”‚ â€¢ labs_sessions â”‚         â”‚  (Every Minute)    â”‚    â”‚  Service Cleanup   â”‚
   â”‚ â€¢ UNIQUE user_idâ”‚         â”‚                    â”‚    â”‚                    â”‚
   â”‚ â€¢ JSON fields   â”‚         â”‚  cleanupExpired()  â”‚    â”‚  Retry Logic       â”‚
   â”‚ â€¢ Timestamps    â”‚         â”‚  â€¢ Query expired   â”‚    â”‚  Multi-node        â”‚
   â”‚                 â”‚         â”‚  â€¢ Delete VMs      â”‚    â”‚                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â€¢ Remove sessions â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Request Flow - Authenticated API Call

```
1. Client Request
   â”‚
   â”œâ”€â–º Include Authorization: Bearer <token>
   â”‚
   â–¼

2. Cloudflare Edge (Router)
   â”‚
   â”œâ”€â–º Extract Bearer token from header
   â”‚
   â”œâ”€â–º authenticateRequest(token, CF_WORKER_TOKEN)
   â”‚   â”‚
   â”‚   â”œâ”€â–º timingSafeEqual() - Constant-time comparison
   â”‚   â”‚
   â”‚   â””â”€â–º Match? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â–º YES: Continue to handler
   â”‚                       â”‚
   â”‚                       â””â”€â”€â”€â–º NO: Return 401 Unauthorized
   â”‚
   â–¼

3. Handler (handlers.ts)
   â”‚
   â”œâ”€â–º Log operation start
   â”‚
   â”œâ”€â–º Validate request data
   â”‚
   â”œâ”€â–º Query/Update D1 Database
   â”‚
   â”œâ”€â–º Log database operation
   â”‚
   â”œâ”€â–º Format response
   â”‚
   â”œâ”€â–º Log operation success/failure
   â”‚
   â””â”€â–º Return response to client
```

## Automatic Cleanup Flow - Cron Trigger

```
Every Minute:

1. Cron Trigger Fires
   â”‚
   â–¼

2. cleanupExpiredSessions()
   â”‚
   â”œâ”€â–º Log cron execution start
   â”‚
   â”œâ”€â–º Query D1: SELECT * WHERE created_at + duration < NOW()
   â”‚
   â””â”€â–º For each expired session:
       â”‚
       â”œâ”€â–º Extract lab_request_ids
       â”‚   â”‚
       â”‚   â”œâ”€â–º Master: session.lab_request_id
       â”‚   â”‚
       â”‚   â””â”€â–º Workers: worker_nodes[].worker_lab_request_id
       â”‚
       â”œâ”€â–º Deduplicate IDs using Set
       â”‚
       â”œâ”€â–º callBackendCleanup(labRequestIds)
       â”‚   â”‚
       â”‚   â”œâ”€â–º For each lab_request_id:
       â”‚   â”‚   â”‚
       â”‚   â”‚   â”œâ”€â–º POST to BACKEND_API_URL/delete/{id}
       â”‚   â”‚   â”‚
       â”‚   â”‚   â”œâ”€â–º Retry on failure (max 3 times)
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€â–º Log success/failure
       â”‚   â”‚
       â”‚   â””â”€â–º Return results
       â”‚
       â”œâ”€â–º DELETE FROM labs_sessions WHERE id = ?
       â”‚
       â”œâ”€â–º Log session deleted
       â”‚
       â””â”€â–º Continue to next expired session

3. Log cron execution complete
   â”‚
   â””â”€â–º Report success/error counts
```

## Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Request with Authorization: Bearer <token>
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Cloudflare Worker Edge              â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  extractBearerToken()                  â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  â€¢ Get Authorization header            â”‚ â”‚
â”‚  â”‚  â€¢ Check format: "Bearer <token>"      â”‚ â”‚
â”‚  â”‚  â€¢ Extract token                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                            â”‚
â”‚                 â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  authenticateRequest()                 â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  â€¢ Get CF_WORKER_TOKEN from env        â”‚ â”‚
â”‚  â”‚  â€¢ Call timingSafeEqual()              â”‚ â”‚
â”‚  â”‚    â”œâ”€â–º Constant-time comparison        â”‚ â”‚
â”‚  â”‚    â””â”€â–º Prevents timing attacks         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                            â”‚
â”‚                 â”œâ”€â–º Valid Token             â”‚
â”‚                 â”‚   â””â”€â–º Execute Handler     â”‚
â”‚                 â”‚                            â”‚
â”‚                 â””â”€â–º Invalid Token           â”‚
â”‚                     â””â”€â–º 401 Unauthorized    â”‚
â”‚                         â””â”€â–º Log warning     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema

```
labs_sessions table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column              â”‚ Type         â”‚ Constraints             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚ TEXT         â”‚ PRIMARY KEY             â”‚
â”‚ labId               â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ labTitle            â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ labGroupID          â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ moduleID            â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ duration            â”‚ INTEGER      â”‚ NOT NULL (minutes)      â”‚
â”‚ activatedAt         â”‚ TEXT         â”‚ NOT NULL (ISO 8601)     â”‚
â”‚ counterID           â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ configId            â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ workerConfigId      â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ lab_request_id      â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ user_id             â”‚ TEXT         â”‚ UNIQUE NOT NULL         â”‚
â”‚ terminal_url        â”‚ TEXT         â”‚ NOT NULL                â”‚
â”‚ validation          â”‚ INTEGER      â”‚ NOT NULL                â”‚
â”‚ vm                  â”‚ TEXT         â”‚ JSON (name, network_id, â”‚
â”‚                     â”‚              â”‚       netbird_ip)       â”‚
â”‚ vscode_domain       â”‚ TEXT         â”‚                         â”‚
â”‚ puku_domain         â”‚ TEXT         â”‚                         â”‚
â”‚ worker_nodes        â”‚ TEXT         â”‚ JSON ARRAY              â”‚
â”‚ loadBalancers       â”‚ TEXT         â”‚ JSON ARRAY              â”‚
â”‚ created_at          â”‚ TEXT         â”‚ DEFAULT CURRENT_TIME    â”‚
â”‚ updated_at          â”‚ TEXT         â”‚ DEFAULT CURRENT_TIME    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Indexes:
â€¢ PRIMARY KEY on id
â€¢ UNIQUE INDEX on user_id (enforces one lab per user)
```

## Logging System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Logger Class                              â”‚
â”‚                                                                â”‚
â”‚  LogLevel Enum:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ DEBUG  â”‚  INFO  â”‚  WARN  â”‚ ERROR  â”‚CRITICALâ”‚              â”‚
â”‚  â”‚   0    â”‚   1    â”‚   2    â”‚   3    â”‚   4    â”‚              â”‚
â”‚  â”‚  ğŸ”    â”‚  â„¹ï¸    â”‚  âš ï¸    â”‚  âŒ    â”‚  ğŸš¨    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                â”‚
â”‚  Specialized Methods:                                          â”‚
â”‚  â€¢ logRequest(method, url, context)                           â”‚
â”‚  â€¢ logOperationStart(operation, context)                      â”‚
â”‚  â€¢ logOperationSuccess(operation, duration, context)          â”‚
â”‚  â€¢ logOperationFailure(operation, error, duration, context)   â”‚
â”‚  â€¢ logDatabaseOperation(operation, table, duration)           â”‚
â”‚  â€¢ logApiCall(endpoint, method, statusCode, duration)         â”‚
â”‚  â€¢ logCronExecution(success, processed, errors)               â”‚
â”‚  â€¢ logSessionCreated(userId, labId, sessionId)                â”‚
â”‚  â€¢ logSessionRetrieved(userId, sessionId)                     â”‚
â”‚  â€¢ logSessionUpdated(userId, sessionId, fields)               â”‚
â”‚  â€¢ logSessionDeleted(userId, sessionId, reason)               â”‚
â”‚                                                                â”‚
â”‚  Child Logger:                                                 â”‚
â”‚  â€¢ child(additionalContext) - Creates logger with more contextâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Transport    â”‚  â”‚ Authentication â”‚  â”‚   Database     â”‚
â”‚   Security    â”‚  â”‚    Layer       â”‚  â”‚   Security     â”‚
â”‚               â”‚  â”‚                â”‚  â”‚                â”‚
â”‚ â€¢ HTTPS Only  â”‚  â”‚ â€¢ Bearer Token â”‚  â”‚ â€¢ Prepared     â”‚
â”‚ â€¢ Cloudflare  â”‚  â”‚ â€¢ Timing-safe  â”‚  â”‚   Statements   â”‚
â”‚   SSL/TLS     â”‚  â”‚   Comparison   â”‚  â”‚ â€¢ Input        â”‚
â”‚ â€¢ Edge        â”‚  â”‚ â€¢ Secret Store â”‚  â”‚   Validation   â”‚
â”‚   Encryption  â”‚  â”‚ â€¢ 401 on Fail  â”‚  â”‚ â€¢ No SQL       â”‚
â”‚               â”‚  â”‚ â€¢ Log Attempts â”‚  â”‚   Injection    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  CORS Security   â”‚
                  â”‚                  â”‚
                  â”‚ â€¢ Configurable   â”‚
                  â”‚   Origins        â”‚
                  â”‚ â€¢ Header         â”‚
                  â”‚   Whitelist      â”‚
                  â”‚ â€¢ Method         â”‚
                  â”‚   Whitelist      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Development Environment                      â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  TypeScriptâ”‚â”€â”€â”€â”€â”€â–ºâ”‚  Wrangler  â”‚â”€â”€â”€â”€â”€â–ºâ”‚   Build    â”‚       â”‚
â”‚  â”‚   Source   â”‚      â”‚    CLI     â”‚      â”‚   Output   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ npm run deploy
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Cloudflare Global Network                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Cloudflare Workers                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Deployed to 300+ Edge Locations Worldwide               â”‚  â”‚
â”‚  â”‚  â€¢ Automatic scaling                                      â”‚  â”‚
â”‚  â”‚  â€¢ Near-zero latency                                      â”‚  â”‚
â”‚  â”‚  â€¢ DDoS protection                                        â”‚  â”‚
â”‚  â”‚  â€¢ SSL/TLS termination                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     D1 Database                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â€¢ SQLite-based                                           â”‚  â”‚
â”‚  â”‚  â€¢ Replicated across regions                             â”‚  â”‚
â”‚  â”‚  â€¢ Automatic backups                                      â”‚  â”‚
â”‚  â”‚  â€¢ ACID transactions                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Secrets Management                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â€¢ Encrypted at rest                                      â”‚  â”‚
â”‚  â”‚  â€¢ CF_WORKER_TOKEN                                        â”‚  â”‚
â”‚  â”‚  â€¢ BACKEND_API_URL                                        â”‚  â”‚
â”‚  â”‚  â€¢ BACKEND_API_TOKEN                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - Complete CRUD Cycle

```
CREATE:
Client â”€â–º [AUTH] â”€â–º Handler â”€â–º Validate â”€â–º INSERT INTO D1 â”€â–º Response
                      â”‚                         â”‚
                      â””â”€â–º Log Start             â””â”€â–º Log DB Op
                                                    â””â”€â–º Log Success

READ:
Client â”€â–º [AUTH] â”€â–º Handler â”€â–º SELECT FROM D1 â”€â–º Response
                      â”‚              â”‚
                      â””â”€â–º Log Start  â””â”€â–º Log DB Op
                                         â””â”€â–º Log Success

UPDATE:
Client â”€â–º [AUTH] â”€â–º Handler â”€â–º Validate â”€â–º UPDATE D1 â”€â–º Response
                      â”‚                        â”‚
                      â””â”€â–º Log Start            â””â”€â–º Log DB Op
                                                   â””â”€â–º Log Success

DELETE:
Client â”€â–º [AUTH] â”€â–º Handler â”€â–º DELETE FROM D1 â”€â–º Call Backend API â”€â–º Response
                      â”‚              â”‚               (delete VMs)
                      â””â”€â–º Log Start  â””â”€â–º Log DB Op
                                         â””â”€â–º Log API Call
                                             â””â”€â–º Log Success

AUTO-DELETE (Cron):
Cron â”€â–º Query Expired â”€â–º DELETE FROM D1 â”€â–º Call Backend API
  â”‚                           â”‚               (delete VMs)
  â””â”€â–º Log Cron Start         â””â”€â–º Log DB Op
                                  â””â”€â–º Log API Call
                                      â””â”€â–º Log Cron Complete
```

## Technology Stack Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer             â”‚  Technology         â”‚  Purpose           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Runtime           â”‚  Cloudflare Workers â”‚  Edge compute      â”‚
â”‚  Language          â”‚  TypeScript         â”‚  Type safety       â”‚
â”‚  Database          â”‚  D1 (SQLite)        â”‚  State storage     â”‚
â”‚  Scheduler         â”‚  Cron Triggers      â”‚  Auto cleanup      â”‚
â”‚  Authentication    â”‚  Bearer Token       â”‚  API security      â”‚
â”‚  Logging           â”‚  Custom Logger      â”‚  Observability     â”‚
â”‚  Build Tool        â”‚  esbuild/Wrangler   â”‚  Compilation       â”‚
â”‚  Package Manager   â”‚  npm                â”‚  Dependencies      â”‚
â”‚  Version Control   â”‚  Git                â”‚  Source control    â”‚
â”‚  Secrets           â”‚  Wrangler Secrets   â”‚  Credentials       â”‚
â”‚  CORS              â”‚  Custom Middleware  â”‚  Cross-origin      â”‚
â”‚  Error Handling    â”‚  Try-Catch + Logger â”‚  Fault tolerance   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Monitoring & Observability

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Monitoring Dashboard                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Logs       â”‚  â”‚   Metrics    â”‚  â”‚   Analytics     â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ â€¢ wrangler   â”‚  â”‚ â€¢ Request    â”‚  â”‚ â€¢ Success rate  â”‚  â”‚
â”‚  â”‚   tail       â”‚  â”‚   rate       â”‚  â”‚ â€¢ Error rate    â”‚  â”‚
â”‚  â”‚ â€¢ Structured â”‚  â”‚ â€¢ Response   â”‚  â”‚ â€¢ Latency       â”‚  â”‚
â”‚  â”‚   JSON       â”‚  â”‚   time       â”‚  â”‚ â€¢ Auth failures â”‚  â”‚
â”‚  â”‚ â€¢ 5 levels   â”‚  â”‚ â€¢ Error rate â”‚  â”‚ â€¢ Cron success  â”‚  â”‚
â”‚  â”‚ â€¢ Context    â”‚  â”‚ â€¢ DB queries â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Features

âœ… **Global Edge Deployment** - 300+ locations worldwide  
âœ… **Automatic Scaling** - Handles traffic spikes  
âœ… **Secure Authentication** - Bearer token with timing-safe comparison  
âœ… **Automatic Cleanup** - Cron-based session expiration  
âœ… **Multi-Node Support** - Kubernetes master + worker nodes  
âœ… **Comprehensive Logging** - 5 levels with structured context  
âœ… **CORS Support** - Cross-origin requests enabled  
âœ… **Type Safety** - Full TypeScript implementation  
âœ… **Zero Downtime** - Edge routing and failover  
âœ… **Developer Friendly** - REST API with clear documentation  

---

*Architecture designed for scale, security, and observability*
